name: Test Gitea Connection

on:
  workflow_dispatch:
    inputs:
      run_full_test:
        description: 'è¿è¡Œå®Œæ•´æµ‹è¯•ï¼ˆåŒ…æ‹¬åˆ›å»ºæµ‹è¯• Releaseï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  test-connection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Gitea API Connection
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
          GITEA_URL: ${{ secrets.GITEA_URL }}
          GITEA_REPO: ${{ secrets.GITEA_REPO }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Gitea é…ç½®æµ‹è¯•"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # ============================================
          # æ­¥éª¤ 1: æ£€æŸ¥ç¯å¢ƒå˜é‡
          # ============================================
          echo "ğŸ“‹ æ­¥éª¤ 1/5: æ£€æŸ¥ç¯å¢ƒå˜é‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -z "$GITEA_TOKEN" ]; then
            echo "âŒ GITEA_TOKEN æœªè®¾ç½®"
            exit 1
          else
            echo "âœ… GITEA_TOKEN å·²è®¾ç½® (${#GITEA_TOKEN} å­—ç¬¦)"
          fi
          
          if [ -z "$GITEA_URL" ]; then
            echo "âŒ GITEA_URL æœªè®¾ç½®"
            exit 1
          else
            echo "âœ… GITEA_URL: $GITEA_URL"
          fi
          
          if [ -z "$GITEA_REPO" ]; then
            echo "âŒ GITEA_REPO æœªè®¾ç½®"
            exit 1
          else
            echo "âœ… GITEA_REPO: $GITEA_REPO"
          fi
          
          echo ""
          
          # ============================================
          # æ­¥éª¤ 2: æµ‹è¯• API è¿æ¥å’Œè®¤è¯
          # ============================================
          echo "ğŸ“‹ æ­¥éª¤ 2/5: æµ‹è¯• API è¿æ¥å’Œè®¤è¯"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/user.json \
            -H "Authorization: token $GITEA_TOKEN" \
            "${GITEA_URL}/api/v1/user")
          
          if [ "$HTTP_CODE" == "200" ]; then
            USERNAME=$(jq -r '.login' /tmp/user.json)
            USER_ID=$(jq -r '.id' /tmp/user.json)
            USER_EMAIL=$(jq -r '.email' /tmp/user.json)
            echo "âœ… API è¿æ¥æˆåŠŸï¼"
            echo "   ç”¨æˆ·å: $USERNAME"
            echo "   ç”¨æˆ· ID: $USER_ID"
            echo "   é‚®ç®±: $USER_EMAIL"
          else
            echo "âŒ API è¿æ¥å¤±è´¥ (HTTP $HTTP_CODE)"
            echo "å“åº”å†…å®¹:"
            cat /tmp/user.json
            exit 1
          fi
          
          echo ""
          
          # ============================================
          # æ­¥éª¤ 3: æµ‹è¯•ä»“åº“è®¿é—®æƒé™
          # ============================================
          echo "ğŸ“‹ æ­¥éª¤ 3/5: æµ‹è¯•ä»“åº“è®¿é—®æƒé™"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/repo.json \
            -H "Authorization: token $GITEA_TOKEN" \
            "${GITEA_URL}/api/v1/repos/${GITEA_REPO}")
          
          if [ "$HTTP_CODE" == "200" ]; then
            REPO_NAME=$(jq -r '.full_name' /tmp/repo.json)
            REPO_PRIVATE=$(jq -r '.private' /tmp/repo.json)
            REPO_DEFAULT_BRANCH=$(jq -r '.default_branch' /tmp/repo.json)
            REPO_SIZE=$(jq -r '.size' /tmp/repo.json)
            echo "âœ… ä»“åº“è®¿é—®æˆåŠŸï¼"
            echo "   ä»“åº“å…¨å: $REPO_NAME"
            echo "   ç§æœ‰ä»“åº“: $REPO_PRIVATE"
            echo "   é»˜è®¤åˆ†æ”¯: $REPO_DEFAULT_BRANCH"
            echo "   ä»“åº“å¤§å°: $REPO_SIZE KB"
          else
            echo "âŒ ä»“åº“è®¿é—®å¤±è´¥ (HTTP $HTTP_CODE)"
            echo "å“åº”å†…å®¹:"
            cat /tmp/repo.json
            exit 1
          fi
          
          echo ""
          
          # ============================================
          # æ­¥éª¤ 4: æ£€æŸ¥ç°æœ‰ Releases
          # ============================================
          echo "ğŸ“‹ æ­¥éª¤ 4/5: æ£€æŸ¥ç°æœ‰ Releases"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/releases.json \
            -H "Authorization: token $GITEA_TOKEN" \
            "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases?page=1&limit=5")
          
          if [ "$HTTP_CODE" == "200" ]; then
            RELEASE_COUNT=$(jq '. | length' /tmp/releases.json)
            echo "âœ… Releases åˆ—è¡¨è·å–æˆåŠŸ"
            echo "   æœ€è¿‘ Releases æ•°é‡: $RELEASE_COUNT"
            
            if [ "$RELEASE_COUNT" -gt 0 ]; then
              echo ""
              echo "   æœ€è¿‘çš„ Releases:"
              jq -r '.[] | "   - \(.tag_name): \(.name)"' /tmp/releases.json | head -5
            fi
          else
            echo "âš ï¸  æ— æ³•è·å– Releases åˆ—è¡¨ (HTTP $HTTP_CODE)"
            echo "   è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼ˆä»“åº“è¿˜æ²¡æœ‰ Releasesï¼‰"
          fi
          
          echo ""
          
          # ============================================
          # æ­¥éª¤ 5: æµ‹è¯• Token æƒé™
          # ============================================
          echo "ğŸ“‹ æ­¥éª¤ 5/5: æµ‹è¯• Token æƒé™"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # æµ‹è¯•æ˜¯å¦æœ‰å†™å…¥æƒé™ï¼ˆé€šè¿‡è·å–ä»“åº“çš„ permissionsï¼‰
          PERMISSIONS=$(jq -r '.permissions' /tmp/repo.json)
          CAN_PUSH=$(echo $PERMISSIONS | jq -r '.push')
          CAN_ADMIN=$(echo $PERMISSIONS | jq -r '.admin')
          
          echo "âœ… Token æƒé™æ£€æŸ¥ï¼š"
          echo "   Push æƒé™: $CAN_PUSH"
          echo "   Admin æƒé™: $CAN_ADMIN"
          
          if [ "$CAN_PUSH" != "true" ]; then
            echo ""
            echo "âš ï¸  è­¦å‘Š: Token æ²¡æœ‰ Push æƒé™"
            echo "   åˆ›å»º Release å¯èƒ½ä¼šå¤±è´¥"
            echo "   è¯·ç¡®ä¿ Token å…·æœ‰ 'write:repository' æƒé™"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ åŸºç¡€é…ç½®æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Full Release Test
        if: ${{ github.event.inputs.run_full_test == 'true' }}
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
          GITEA_URL: ${{ secrets.GITEA_URL }}
          GITEA_REPO: ${{ secrets.GITEA_REPO }}
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª å®Œæ•´ Release åŒæ­¥æµ‹è¯•"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          TEST_TAG="test-release-$(date +%s)"
          TEST_RELEASE_NAME="Test Release $(date +%Y-%m-%d-%H-%M-%S)"
          
          echo "ğŸ“ æµ‹è¯•ä¿¡æ¯:"
          echo "   Tag: $TEST_TAG"
          echo "   Release åç§°: $TEST_RELEASE_NAME"
          echo ""
          
          # ============================================
          # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
          # ============================================
          echo "ğŸ“‹ æ­¥éª¤ 1/4: åˆ›å»ºæµ‹è¯•æ–‡ä»¶"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          mkdir -p test-assets
          
          # åˆ›å»ºä¸€ä¸ªå°çš„æµ‹è¯•æ–‡ä»¶
          echo "This is a test file for Gitea Release sync" > test-assets/test-file.txt
          echo "Timestamp: $(date)" >> test-assets/test-file.txt
          echo "Workflow run: ${{ github.run_number }}" >> test-assets/test-file.txt
          
          # åˆ›å»ºä¸€ä¸ª JSON æµ‹è¯•æ–‡ä»¶
          cat > test-assets/test-config.json <<EOF
          {
            "test": true,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run": "${{ github.run_number }}",
            "repository": "$GITEA_REPO"
          }
          EOF
          
          echo "âœ… åˆ›å»ºäº†ä»¥ä¸‹æµ‹è¯•æ–‡ä»¶:"
          ls -lh test-assets/
          
          echo ""
          
          # ============================================
          # åˆ›å»ºæµ‹è¯• Release
          # ============================================
          echo "ğŸ“‹ æ­¥éª¤ 2/4: åˆ›å»ºæµ‹è¯• Release"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # ç¦ç”¨é€šé…ç¬¦å±•å¼€ï¼Œé˜²æ­¢ RELEASE_BODY ä¸­çš„ * è¢«è¯¯è§£æ
          set -f
          
          RELEASE_BODY="## ğŸ§ª è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• Release

          æœ¬ Release ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºæµ‹è¯• Gitea Release åŒæ­¥åŠŸèƒ½ã€‚
          
          ### æµ‹è¯•ä¿¡æ¯
          - **å·¥ä½œæµè¿è¡Œ**: #${{ github.run_number }}
          - **åˆ›å»ºæ—¶é—´**: $(date)
          - **æµ‹è¯•æ ‡ç­¾**: \`$TEST_TAG\`
          
          ### âœ… æµ‹è¯•é¡¹ç›®
          - [x] API è®¤è¯
          - [x] ä»“åº“æƒé™
          - [x] Release åˆ›å»º
          - [x] æ–‡ä»¶ä¸Šä¼ 
          
          > âš ï¸ è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• Releaseï¼Œå¯ä»¥å®‰å…¨åˆ é™¤ã€‚
          
          ### ğŸ“¦ æµ‹è¯•å®‰è£…åŒ…æ ¼å¼
          - **macOS (Apple Silicon)**: \`*_aarch64.dmg\` æˆ– \`*.app.tar.gz\`
          - **macOS (Intel)**: \`*_x64.dmg\` æˆ– \`*.app.tar.gz\`
          - **Windows**: \`*.msi\` æˆ– \`*.exe\`
          
          è¿™äº›é€šé…ç¬¦ç”¨äºæµ‹è¯• bash è„šæœ¬æ˜¯å¦æ­£ç¡®å¤„ç†ç‰¹æ®Šå­—ç¬¦ã€‚"
          
          BODY_JSON=$(printf '%s' "$RELEASE_BODY" | jq -Rs .)
          
          CREATE_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: token $GITEA_TOKEN" \
            -H "Content-Type: application/json" \
            "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases" \
            -d @- <<EOF
          {
            "tag_name": "$TEST_TAG",
            "name": "$TEST_RELEASE_NAME",
            "body": $BODY_JSON,
            "draft": false,
            "prerelease": true
          }
          EOF
          )
          
          HTTP_CODE=$(echo "$CREATE_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$CREATE_RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" == "201" ]; then
            RELEASE_ID=$(echo "$RESPONSE_BODY" | jq -r '.id')
            RELEASE_URL=$(echo "$RESPONSE_BODY" | jq -r '.html_url')
            echo "âœ… æµ‹è¯• Release åˆ›å»ºæˆåŠŸï¼"
            echo "   Release ID: $RELEASE_ID"
            echo "   Release URL: $RELEASE_URL"
          else
            echo "âŒ Release åˆ›å»ºå¤±è´¥ (HTTP $HTTP_CODE)"
            echo "å“åº”å†…å®¹:"
            echo "$RESPONSE_BODY" | jq '.'
            exit 1
          fi
          
          echo ""
          
          # ============================================
          # ä¸Šä¼ æµ‹è¯•æ–‡ä»¶
          # ============================================
          echo "ğŸ“‹ æ­¥éª¤ 3/4: ä¸Šä¼ æµ‹è¯•æ–‡ä»¶"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          UPLOAD_SUCCESS=0
          UPLOAD_FAILED=0
          
          # è·å–æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ï¼ˆä¸ä½¿ç”¨é€šé…ç¬¦ï¼‰
          ASSET_FILES=$(find test-assets -type f -maxdepth 1 2>/dev/null)
          
          if [ -z "$ASSET_FILES" ]; then
            echo "âš ï¸  No test assets found"
          else
            echo "$ASSET_FILES" | while read -r asset; do
              if [ -f "$asset" ]; then
                filename=$(basename "$asset")
                filesize=$(ls -lh "$asset" | awk '{print $5}')
                echo "â³ ä¸Šä¼ : $filename ($filesize)"
                
                UPLOAD_CODE=$(curl -s -w "%{http_code}" -o /tmp/upload.json \
                  -H "Authorization: token $GITEA_TOKEN" \
                  -F "attachment=@${asset}" \
                  "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases/${RELEASE_ID}/assets?name=${filename}")
                
                if [ "$UPLOAD_CODE" == "201" ]; then
                  ASSET_ID=$(jq -r '.id' /tmp/upload.json)
                  echo "   âœ… ä¸Šä¼ æˆåŠŸ (Asset ID: $ASSET_ID)"
                  UPLOAD_SUCCESS=$((UPLOAD_SUCCESS + 1))
                else
                  echo "   âŒ ä¸Šä¼ å¤±è´¥ (HTTP $UPLOAD_CODE)"
                  cat /tmp/upload.json
                  UPLOAD_FAILED=$((UPLOAD_FAILED + 1))
                fi
              fi
            done
          fi
          
          echo ""
          echo "ä¸Šä¼ ç»“æœ:"
          echo "   âœ… æˆåŠŸ: $UPLOAD_SUCCESS"
          echo "   âŒ å¤±è´¥: $UPLOAD_FAILED"
          
          if [ $UPLOAD_FAILED -gt 0 ]; then
            echo ""
            echo "âš ï¸  éƒ¨åˆ†æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
          fi
          
          echo ""
          
          # ============================================
          # éªŒè¯ Release
          # ============================================
          echo "ğŸ“‹ æ­¥éª¤ 4/4: éªŒè¯ Release"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          VERIFY_CODE=$(curl -s -w "%{http_code}" -o /tmp/verify.json \
            -H "Authorization: token $GITEA_TOKEN" \
            "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases/${RELEASE_ID}")
          
          if [ "$VERIFY_CODE" == "200" ]; then
            ASSET_COUNT=$(jq '.assets | length' /tmp/verify.json)
            echo "âœ… Release éªŒè¯æˆåŠŸ"
            echo "   Assets æ•°é‡: $ASSET_COUNT"
            echo ""
            echo "   å·²ä¸Šä¼ çš„æ–‡ä»¶:"
            jq -r '.assets[] | "   - \(.name) (\(.size) bytes)"' /tmp/verify.json
          else
            echo "âŒ Release éªŒè¯å¤±è´¥ (HTTP $VERIFY_CODE)"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ å®Œæ•´æµ‹è¯•å®Œæˆï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ æµ‹è¯• Release ä¿¡æ¯:"
          echo "   URL: $RELEASE_URL"
          echo "   Tag: $TEST_TAG"
          echo ""
          echo "âš ï¸  æç¤º: è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• Releaseï¼Œæ‚¨å¯ä»¥åœ¨ Gitea ä¸­æ‰‹åŠ¨åˆ é™¤å®ƒ"
          echo "   åˆ é™¤é“¾æ¥: $GITEA_URL/$GITEA_REPO/releases"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š æµ‹è¯•æ€»ç»“"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… åŸºç¡€é…ç½®æµ‹è¯•: é€šè¿‡"
          
          if [ "${{ github.event.inputs.run_full_test }}" == "true" ]; then
            echo "âœ… å®Œæ•´ Release æµ‹è¯•: å·²æ‰§è¡Œ"
            echo ""
            echo "ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ:"
            echo "   1. æ£€æŸ¥ Gitea ä»“åº“ä¸­çš„æµ‹è¯• Release"
            echo "   2. éªŒè¯æ–‡ä»¶æ˜¯å¦æ­£ç¡®ä¸Šä¼ "
            echo "   3. åˆ é™¤æµ‹è¯• Releaseï¼ˆå¯é€‰ï¼‰"
            echo "   4. å‡†å¤‡è¿›è¡ŒçœŸå®çš„ç‰ˆæœ¬å‘å¸ƒ"
          else
            echo "â­ï¸  å®Œæ•´ Release æµ‹è¯•: æœªæ‰§è¡Œ"
            echo ""
            echo "ğŸ’¡ æç¤º: é‡æ–°è¿è¡Œæ­¤å·¥ä½œæµå¹¶å‹¾é€‰"
            echo "   'è¿è¡Œå®Œæ•´æµ‹è¯•' é€‰é¡¹ä»¥æµ‹è¯•å®Œæ•´çš„"
            echo "   Release åˆ›å»ºå’Œæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

