name: Test Gitea Connection

on:
  workflow_dispatch:

jobs:
  test-connection:
    runs-on: ubuntu-latest
    steps:
      - name: Test Gitea API Connection
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
          GITEA_URL: ${{ secrets.GITEA_URL }}
          GITEA_REPO: ${{ secrets.GITEA_REPO }}
        run: |
          echo "üîç Testing Gitea configuration..."
          echo ""
          
          # Ê£ÄÊü•ÁéØÂ¢ÉÂèòÈáèÊòØÂê¶ËÆæÁΩÆ
          if [ -z "$GITEA_TOKEN" ]; then
            echo "‚ùå GITEA_TOKEN is not set"
            exit 1
          else
            echo "‚úÖ GITEA_TOKEN is set (${#GITEA_TOKEN} characters)"
          fi
          
          if [ -z "$GITEA_URL" ]; then
            echo "‚ùå GITEA_URL is not set"
            exit 1
          else
            echo "‚úÖ GITEA_URL: $GITEA_URL"
          fi
          
          if [ -z "$GITEA_REPO" ]; then
            echo "‚ùå GITEA_REPO is not set"
            exit 1
          else
            echo "‚úÖ GITEA_REPO: $GITEA_REPO"
          fi
          
          echo ""
          echo "üåê Testing API connection..."
          
          # ÊµãËØï API ËøûÊé•
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/user.json \
            -H "Authorization: token $GITEA_TOKEN" \
            "${GITEA_URL}/api/v1/user")
          
          if [ "$HTTP_CODE" == "200" ]; then
            USERNAME=$(jq -r '.login' /tmp/user.json)
            echo "‚úÖ API connection successful!"
            echo "   Authenticated as: $USERNAME"
          else
            echo "‚ùå API connection failed (HTTP $HTTP_CODE)"
            cat /tmp/user.json
            exit 1
          fi
          
          echo ""
          echo "üì¶ Testing repository access..."
          
          # ÊµãËØï‰ªìÂ∫ìËÆøÈóÆ
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/repo.json \
            -H "Authorization: token $GITEA_TOKEN" \
            "${GITEA_URL}/api/v1/repos/${GITEA_REPO}")
          
          if [ "$HTTP_CODE" == "200" ]; then
            REPO_NAME=$(jq -r '.full_name' /tmp/repo.json)
            REPO_PRIVATE=$(jq -r '.private' /tmp/repo.json)
            echo "‚úÖ Repository access successful!"
            echo "   Repository: $REPO_NAME"
            echo "   Private: $REPO_PRIVATE"
          else
            echo "‚ùå Repository access failed (HTTP $HTTP_CODE)"
            cat /tmp/repo.json
            exit 1
          fi
          
          echo ""
          echo "üéâ All tests passed! Your Gitea configuration is correct."
          echo ""
          echo "Next steps:"
          echo "  1. Push to 'release' branch to trigger a real release"
          echo "  2. Or manually trigger the 'publish' workflow"

