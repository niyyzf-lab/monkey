name: 'Update Gitea JSON URLs'

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag to update (e.g., v0.2.37)'
        required: true
        type: string
  workflow_run:
    workflows: ["publish"]
    types:
      - completed

jobs:
  update-gitea-json:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set release tag
        id: set_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          else
            # ‰ªé GitHub Ëé∑ÂèñÊúÄÊñ∞ÁöÑ release tag
            TAG_NAME=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" | jq -r '.tag_name')
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "üìå Processing tag: $TAG_NAME"

      - name: Download JSON files from Gitea
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
          GITEA_URL: ${{ secrets.GITEA_URL }}
          GITEA_REPO: ${{ secrets.GITEA_REPO }}
          TAG_NAME: ${{ steps.set_tag.outputs.tag_name }}
        run: |
          mkdir -p gitea-json-files
          
          echo "üì• Downloading JSON files from Gitea release $TAG_NAME..."
          
          # Ëé∑Âèñ Gitea release ‰ø°ÊÅØ
          RELEASE_DATA=$(curl -s -H "Authorization: token $GITEA_TOKEN" \
            "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases/tags/${TAG_NAME}")
          
          RELEASE_ID=$(echo "$RELEASE_DATA" | jq -r '.id')
          
          if [ "$RELEASE_ID" == "null" ] || [ -z "$RELEASE_ID" ]; then
            echo "‚ùå Release $TAG_NAME not found in Gitea"
            exit 1
          fi
          
          echo "‚úÖ Found release ID: $RELEASE_ID"
          
          # Ëé∑ÂèñÊâÄÊúâÈôÑ‰ª∂
          ATTACHMENTS=$(echo "$RELEASE_DATA" | jq -r '.assets')
          
          # ‰∏ãËΩΩÊâÄÊúâ .json Êñá‰ª∂
          echo "$ATTACHMENTS" | jq -r '.[] | select(.name | endswith(".json")) | "\(.id) \(.name) \(.browser_download_url)"' | \
          while read attachment_id filename download_url; do
            echo "  üìÑ Downloading $filename..."
            curl -L -H "Authorization: token $GITEA_TOKEN" \
              "$download_url" \
              -o "gitea-json-files/$filename"
            
            if [ -f "gitea-json-files/$filename" ]; then
              echo "  ‚úÖ Downloaded $filename ($(ls -lh "gitea-json-files/$filename" | awk '{print $5}'))"
            else
              echo "  ‚ùå Failed to download $filename"
            fi
          done
          
          echo ""
          echo "üìä Downloaded files:"
          ls -lh gitea-json-files/

      - name: Update URLs in JSON files
        env:
          GITEA_URL: ${{ secrets.GITEA_URL }}
          GITEA_REPO: ${{ secrets.GITEA_REPO }}
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          GITHUB_REPO="${{ github.repository }}"
          
          echo "üîÑ Updating URLs in JSON files..."
          echo "  From: https://github.com/${GITHUB_REPO}/releases/download/"
          echo "  To: ${GITEA_URL}/${GITEA_REPO}/releases/download/"
          echo "  Token: ${GITEA_TOKEN:0:8}..."
          echo ""
          
          JSON_COUNT=0
          
          find gitea-json-files -name "*.json" -type f | while read -r json_file; do
            echo "  üìù Processing $(basename "$json_file")..."
            
            # ÂÖàÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóß token ÂèÇÊï∞
            sed -i.bak 's/\?token=[^"]*//g' "$json_file"
            
            # ÊõøÊç¢ GitHub URL ‰∏∫ Gitea URL
            sed -i.bak \
              "s|https://github.com/${GITHUB_REPO}/releases/download/|${GITEA_URL}/${GITEA_REPO}/releases/download/|g" \
              "$json_file"
            
            # Âú®ÊâÄÊúâ‰∏ãËΩΩ URL ÂêéÊ∑ªÂä† token
            if [ -n "$GITEA_TOKEN" ]; then
              # ÂåπÈÖç Gitea ‰∏ãËΩΩ URL Âπ∂Ê∑ªÂä† token
              sed -i.bak \
                "s|\(${GITEA_URL}/${GITEA_REPO}/releases/download/[^\"]*\)|\1?token=${GITEA_TOKEN}|g" \
                "$json_file"
            fi
            
            # Âà†Èô§ÊâÄÊúâÂ§á‰ªΩÊñá‰ª∂
            rm -f "${json_file}.bak"
            
            echo "  ‚úÖ Updated $(basename "$json_file")"
            JSON_COUNT=$((JSON_COUNT + 1))
            
            # ÊòæÁ§∫Êõ¥Êñ∞ÂêéÁöÑÂÜÖÂÆπÔºàÁî®‰∫éË∞ÉËØïÔºâ
            echo "  üìÑ Content preview:"
            cat "$json_file" | jq -r '.platforms | to_entries[] | "    Platform: \(.key), URL: \(.value.url)"' 2>/dev/null || \
            grep -o "\"url\"[^,}]*" "$json_file" | head -n 2 | sed 's/^/    /'
            echo ""
          done
          
          echo "‚úÖ Updated $JSON_COUNT JSON files"

      - name: Upload updated JSON files back to Gitea
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
          GITEA_URL: ${{ secrets.GITEA_URL }}
          GITEA_REPO: ${{ secrets.GITEA_REPO }}
          TAG_NAME: ${{ steps.set_tag.outputs.tag_name }}
        run: |
          echo "üì§ Uploading updated JSON files back to Gitea..."
          
          # Ëé∑Âèñ release ID
          RELEASE_DATA=$(curl -s -H "Authorization: token $GITEA_TOKEN" \
            "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases/tags/${TAG_NAME}")
          
          RELEASE_ID=$(echo "$RELEASE_DATA" | jq -r '.id')
          
          echo "Release ID: $RELEASE_ID"
          
          # Âà†Èô§ÊóßÁöÑ JSON ÈôÑ‰ª∂
          echo "üóëÔ∏è  Deleting old JSON attachments..."
          echo "$RELEASE_DATA" | jq -r '.assets[] | select(.name | endswith(".json")) | "\(.id) \(.name)"' | \
          while read attachment_id filename; do
            echo "  Deleting $filename (ID: $attachment_id)..."
            DELETE_CODE=$(curl -s -w "%{http_code}" -o /dev/null -X DELETE \
              -H "Authorization: token $GITEA_TOKEN" \
              "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases/${RELEASE_ID}/assets/${attachment_id}")
            
            if [ "$DELETE_CODE" == "204" ]; then
              echo "  ‚úÖ Deleted $filename"
            else
              echo "  ‚ö†Ô∏è  Failed to delete $filename (HTTP $DELETE_CODE)"
            fi
          done
          
          echo ""
          echo "üì§ Uploading updated JSON files..."
          
          UPLOAD_COUNT=0
          
          find gitea-json-files -name "*.json" -type f | while read -r json_file; do
            filename=$(basename "$json_file")
            filesize=$(ls -lh "$json_file" | awk '{print $5}')
            
            echo "  ‚è≥ Uploading $filename ($filesize)..."
            
            UPLOAD_CODE=$(curl -s -w "%{http_code}" -o /dev/null \
              -H "Authorization: token $GITEA_TOKEN" \
              -F "attachment=@${json_file}" \
              "${GITEA_URL}/api/v1/repos/${GITEA_REPO}/releases/${RELEASE_ID}/assets?name=${filename}")
            
            if [ "$UPLOAD_CODE" == "201" ]; then
              echo "  ‚úÖ Uploaded $filename"
              UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
            else
              echo "  ‚ùå Failed to upload $filename (HTTP $UPLOAD_CODE)"
            fi
          done
          
          echo ""
          echo "üéâ Successfully updated Gitea JSON files!"
          echo "üìä Summary:"
          echo "  - Release: $TAG_NAME"
          echo "  - Files updated: $UPLOAD_COUNT"
          echo "  - URL: ${GITEA_URL}/${GITEA_REPO}/releases/tag/${TAG_NAME}"

